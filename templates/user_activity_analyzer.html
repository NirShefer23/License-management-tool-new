{% extends "base.html" %}

{% block title %}User Activity Analyzer - Mobileye Development Tools{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-8">
    <!-- Header -->
    <div class="text-center space-y-4 fade-in">
        <div class="flex items-center justify-center gap-3">
            <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-chart-line text-white text-2xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900">User Activity Analyzer</h1>
                <p class="text-gray-600">Analyze user login/logout activity and license utilization patterns</p>
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-8">
        <!-- Input Panel -->
        <div class="space-y-6 fade-in" style="animation-delay: 0.1s;">
            <!-- Log File Input -->
            <div class="card-glass rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-file-alt text-purple-500"></i>
                    Log File Configuration
                </h3>
                <div class="space-y-4">
                    <div>
                        <label for="log-file-path" class="block text-sm font-medium text-gray-700 mb-2">
                            Log File Path <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="log-file-path" 
                            placeholder='e.g., "license logs/" or "license logs/*.log"'
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        >
                        <p class="text-xs text-gray-500 mt-1">
                            Supports single files, glob patterns, or directories
                        </p>
                    </div>
                </div>
            </div>

            <!-- Analysis Options -->
            <div class="card-glass rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-cogs text-purple-500"></i>
                    Analysis Options
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="output-format" class="block text-sm font-medium text-gray-700 mb-2">
                            Output Format
                        </label>
                        <select id="output-format" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="table">Table</option>
                            <option value="summary">Summary Report</option>
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    <div>
                        <label for="sort-by" class="block text-sm font-medium text-gray-700 mb-2">
                            Sort By
                        </label>
                        <select id="sort-by" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="activity_score">Activity Score</option>
                            <option value="total_login_time">Total Login Time</option>
                            <option value="sessions">Number of Sessions</option>
                            <option value="user_id">User ID</option>
                        </select>
                    </div>
                    <div>
                        <label for="limit" class="block text-sm font-medium text-gray-700 mb-2">
                            Limit Results
                        </label>
                        <input 
                            type="number" 
                            id="limit" 
                            placeholder="e.g., 20"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            min="1"
                        >
                    </div>
                    <div>
                        <label for="top-percentile" class="block text-sm font-medium text-gray-700 mb-2">
                            Top Percentile
                        </label>
                        <input 
                            type="number" 
                            id="top-percentile" 
                            value="0.1"
                            step="0.01"
                            min="0.01"
                            max="0.5"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                        >
                    </div>
                </div>
            </div>

            <!-- Filtering Options -->
            <div class="card-glass rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-filter text-purple-500"></i>
                    Filtering Options
                </h3>
                <div class="space-y-4">
                    <div>
                        <label for="filter-user" class="block text-sm font-medium text-gray-700 mb-2">
                            Filter by User ID
                        </label>
                        <input 
                            type="text" 
                            id="filter-user" 
                            placeholder="e.g., admin"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                        >
                        <p class="text-xs text-gray-500 mt-1">
                            Supports partial matches
                        </p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700 mb-2">
                                Start Date
                            </label>
                            <input 
                                type="date" 
                                id="start-date" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            >
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700 mb-2">
                                End Date
                            </label>
                            <input 
                                type="date" 
                                id="end-date" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            >
                        </div>
                    </div>
                </div>
            </div>

            <!-- Execute Button -->
            <button 
                id="execute-btn" 
                class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-medium py-4 px-6 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
            >
                <i class="fas fa-play mr-2"></i>
                Analyze User Activity
            </button>
        </div>

        <!-- Results Panel -->
        <div class="space-y-6 fade-in" style="animation-delay: 0.2s;">
            <!-- Status Card -->
            <div class="card-glass rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-info-circle text-purple-500"></i>
                    Analysis Status
                </h3>
                <div id="status-content" class="text-center py-8">
                    <i class="fas fa-chart-line text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-500">Configure analysis settings and click "Analyze User Activity" to begin</p>
                </div>
            </div>

            <!-- Results Card -->
            <div id="results-card" class="card-glass rounded-2xl shadow-lg p-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-purple-500"></i>
                        Analysis Results
                    </h3>
                    <div class="flex gap-2">
                        <button 
                            id="copy-results-btn" 
                            class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors"
                            title="Copy to clipboard"
                        >
                            <i class="fas fa-copy"></i>
                        </button>
                        <button 
                            id="download-results-btn" 
                            class="px-3 py-1 text-sm bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg transition-colors"
                            title="Download results"
                        >
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div id="results-content" class="bg-gray-50 rounded-lg p-4 overflow-auto max-h-96">
                    <pre id="results-text" class="whitespace-pre-wrap text-sm text-gray-800"></pre>
                </div>
            </div>

            <!-- Help Card -->
            <div class="card-glass rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-lightbulb text-purple-500"></i>
                    Quick Tips
                </h3>
                <div class="space-y-3 text-sm text-gray-600">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-folder text-purple-400 mt-1 flex-shrink-0"></i>
                        <div>
                            <p class="font-medium text-gray-700">Log File Paths</p>
                            <p>Use "license logs/" for all logs in directory, or "*.log" for specific pattern</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <i class="fas fa-chart-pie text-purple-400 mt-1 flex-shrink-0"></i>
                        <div>
                            <p class="font-medium text-gray-700">Output Formats</p>
                            <p>Choose "Summary" for overview, "Table" for detailed view, "JSON" for data export</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <i class="fas fa-filter text-purple-400 mt-1 flex-shrink-0"></i>
                        <div>
                            <p class="font-medium text-gray-700">Filtering</p>
                            <p>Use date ranges and user filters to focus on specific time periods or users</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <i class="fas fa-percentage text-purple-400 mt-1 flex-shrink-0"></i>
                        <div>
                            <p class="font-medium text-gray-700">Outlier Analysis</p>
                            <p>Set percentile (0.1 = top 10%) to identify most/least active users</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4"></div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Analyzing User Activity</h3>
        <p class="text-gray-600">This may take a few moments...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const executeBtn = document.getElementById('execute-btn');
    const logFilePathInput = document.getElementById('log-file-path');
    const outputFormatSelect = document.getElementById('output-format');
    const sortBySelect = document.getElementById('sort-by');
    const limitInput = document.getElementById('limit');
    const topPercentileInput = document.getElementById('top-percentile');
    const filterUserInput = document.getElementById('filter-user');
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    
    const statusContent = document.getElementById('status-content');
    const resultsCard = document.getElementById('results-card');
    const resultsText = document.getElementById('results-text');
    const loadingModal = document.getElementById('loading-modal');
    const copyResultsBtn = document.getElementById('copy-results-btn');
    const downloadResultsBtn = document.getElementById('download-results-btn');

    executeBtn.addEventListener('click', async function() {
        const logFilePath = logFilePathInput.value.trim();
        
        if (!logFilePath) {
            alert('Please enter a log file path');
            return;
        }

        // Collect form data
        const formData = {
            log_file_path: logFilePath,
            output_format: outputFormatSelect.value,
            sort_by: sortBySelect.value,
            top_percentile: parseFloat(topPercentileInput.value) || 0.1
        };

        // Add optional parameters
        if (limitInput.value) {
            formData.limit = parseInt(limitInput.value);
        }
        if (filterUserInput.value.trim()) {
            formData.filter_user = filterUserInput.value.trim();
        }
        if (startDateInput.value && endDateInput.value) {
            formData.date_range = [startDateInput.value, endDateInput.value];
        }

        // Show loading state
        executeBtn.disabled = true;
        loadingModal.classList.remove('hidden');
        statusContent.innerHTML = `
            <div class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mr-3"></div>
                <span class="text-purple-600">Analyzing user activity...</span>
            </div>
        `;

        try {
            const response = await fetch('/api/execute-user-activity-analyzer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                // Show success status
                statusContent.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                        <p class="text-green-600 font-medium">Analysis completed successfully!</p>
                        <p class="text-gray-500 text-sm mt-2">Duration: ${result.duration.toFixed(2)}s</p>
                    </div>
                `;

                // Show results
                resultsText.textContent = result.output;
                resultsCard.classList.remove('hidden');
                
                // Scroll to results
                resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                // Show error status
                statusContent.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                        <p class="text-red-600 font-medium">Analysis failed</p>
                        <p class="text-gray-600 text-sm mt-2">${result.error}</p>
                    </div>
                `;
                resultsCard.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error:', error);
            statusContent.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-times-circle text-red-500 text-4xl mb-4"></i>
                    <p class="text-red-600 font-medium">Network error</p>
                    <p class="text-gray-600 text-sm mt-2">${error.message}</p>
                </div>
            `;
            resultsCard.classList.add('hidden');
        } finally {
            executeBtn.disabled = false;
            loadingModal.classList.add('hidden');
        }
    });

    // Copy results to clipboard
    copyResultsBtn.addEventListener('click', async function() {
        try {
            await navigator.clipboard.writeText(resultsText.textContent);
            const originalText = copyResultsBtn.innerHTML;
            copyResultsBtn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                copyResultsBtn.innerHTML = originalText;
            }, 2000);
        } catch (err) {
            alert('Failed to copy to clipboard');
        }
    });

    // Download results
    downloadResultsBtn.addEventListener('click', function() {
        const content = resultsText.textContent;
        const outputFormat = outputFormatSelect.value;
        const filename = `user_activity_analysis.${outputFormat === 'json' ? 'json' : 'txt'}`;
        
        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    });

    // Set default log file path
    logFilePathInput.value = 'license logs/';
});
</script>
{% endblock %}