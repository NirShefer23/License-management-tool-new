{% extends "base.html" %}

{% block title %}ReqIF Comparison - Mobileye Development Tools{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8">
    <!-- Header -->
    <div class="text-center space-y-4 fade-in">
        <div class="flex items-center justify-center gap-3">
            <div class="w-16 h-16 bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-chart-line text-white text-2xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900">ReqIF Comparison Tool</h1>
                <p class="text-gray-600">Compare ReqIF files and identify differences with detailed analysis</p>
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-8">
        <!-- Input Panel -->
        <div class="space-y-6 fade-in" style="animation-delay: 0.1s;">
            <!-- File Upload -->
            <div class="card-glass rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-upload text-cyan-500"></i>
                    Upload ReqIF Files
                </h3>
                <div class="space-y-6">
                    <!-- File 1 -->
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">
                            Original File (.reqifz)
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-gray-400 transition-colors">
                            <input
                                id="file1"
                                type="file"
                                accept=".reqifz"
                                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100 transition-colors"
                            />
                            <div id="file1-status" class="mt-3 hidden">
                                <div class="flex items-center gap-2 text-sm text-green-600">
                                    <i class="fas fa-check-circle"></i>
                                    <span id="file1-name"></span>
                                    <span id="file1-size" class="px-2 py-1 bg-gray-100 text-gray-700 rounded-full text-xs"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File 2 -->
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">
                            Comparison File (.reqifz)
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-gray-400 transition-colors">
                            <input
                                id="file2"
                                type="file"
                                accept=".reqifz"
                                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100 transition-colors"
                            />
                            <div id="file2-status" class="mt-3 hidden">
                                <div class="flex items-center gap-2 text-sm text-green-600">
                                    <i class="fas fa-check-circle"></i>
                                    <span id="file2-name"></span>
                                    <span id="file2-size" class="px-2 py-1 bg-gray-100 text-gray-700 rounded-full text-xs"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div id="progress-section" class="hidden">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600">Processing files...</span>
                            <span class="text-gray-900 font-medium" id="progress-text">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progress-bar" class="bg-gradient-to-r from-cyan-500 to-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Compare Button -->
                    <button
                        id="compare-btn"
                        class="btn-primary w-full h-12 rounded-xl text-white font-medium shadow-lg text-base"
                        disabled
                    >
                        <i class="fas fa-exchange-alt mr-2"></i>
                        Compare Files
                    </button>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-cyan-50 border border-cyan-200 rounded-xl p-4">
                <div class="flex items-start gap-3">
                    <i class="fas fa-info-circle text-cyan-500 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-cyan-900 mb-1">How to Use</h4>
                        <p class="text-sm text-cyan-700">
                            <strong>Step 1:</strong> Upload the original ReqIF file (.reqifz format)<br>
                            <strong>Step 2:</strong> Upload the comparison ReqIF file (.reqifz format)<br>
                            <strong>Step 3:</strong> Click "Compare Files" to start analysis<br>
                            <strong>Step 4:</strong> Review the detailed comparison report<br>
                            <strong>Step 5:</strong> Export results for documentation
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="space-y-6 fade-in" style="animation-delay: 0.2s;">
            <div class="card-glass rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-line text-cyan-500"></i>
                    Comparison Results
                    <span id="comparison-status" class="hidden"></span>
                </h3>
                <div id="results-container">
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-chart-line text-4xl mb-4 opacity-50"></i>
                        <p>Comparison results will appear here</p>
                        <p class="text-sm mt-2">Upload two .reqifz files and click compare to start</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let file1 = null;
let file2 = null;

// File upload handlers
document.getElementById('file1').addEventListener('change', function(e) {
    handleFileUpload(e.target.files[0], 'file1');
});

document.getElementById('file2').addEventListener('change', function(e) {
    handleFileUpload(e.target.files[0], 'file2');
});

function handleFileUpload(file, fileId) {
    if (file && file.name.endsWith('.reqifz')) {
        if (fileId === 'file1') {
            file1 = file;
            document.getElementById('file1-name').textContent = file.name;
            document.getElementById('file1-size').textContent = formatFileSize(file.size);
            document.getElementById('file1-status').classList.remove('hidden');
        } else {
            file2 = file;
            document.getElementById('file2-name').textContent = file.name;
            document.getElementById('file2-size').textContent = formatFileSize(file.size);
            document.getElementById('file2-status').classList.remove('hidden');
        }
    } else {
        utils.showNotification('Please select a valid .reqifz file', 'error');
        if (fileId === 'file1') {
            file1 = null;
            document.getElementById('file1-status').classList.add('hidden');
        } else {
            file2 = null;
            document.getElementById('file2-status').classList.add('hidden');
        }
    }
    updateCompareButton();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function updateCompareButton() {
    const compareBtn = document.getElementById('compare-btn');
    compareBtn.disabled = !(file1 && file2);
}

// Compare button click handler
document.getElementById('compare-btn').addEventListener('click', async function() {
    const compareBtn = this;
    const originalText = compareBtn.innerHTML;
    
    // Show loading state
    utils.showLoading(compareBtn);
    
    // Show progress section
    document.getElementById('progress-section').classList.remove('hidden');
    
    try {
        // Prepare form data
        const formData = new FormData();
        formData.append('file1', file1);
        formData.append('file2', file2);
        
        // Show comparison status
        const statusElement = document.getElementById('comparison-status');
        statusElement.innerHTML = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">Comparing...</span>';
        statusElement.classList.remove('hidden');
        
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 10;
            if (progress > 90) {
                clearInterval(progressInterval);
                progress = 90;
            }
            updateProgress(progress);
        }, 200);
        
        // Make API call
        const response = await fetch('/api/execute-reqif-comparison', {
            method: 'POST',
            body: formData
        });
        
        clearInterval(progressInterval);
        updateProgress(100);
        
        const result = await response.json();
        
        // Update status
        if (result.success) {
            statusElement.innerHTML = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Completed</span>';
            utils.showNotification('ReqIF comparison completed successfully', 'success');
        } else {
            statusElement.innerHTML = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">Failed</span>';
            utils.showNotification('ReqIF comparison failed', 'error');
        }
        
        // Display results
        displayComparisonResults(result);
        
    } catch (error) {
        console.error('Error executing ReqIF comparison:', error);
        utils.showNotification('Failed to execute ReqIF comparison tool', 'error');
        
        const statusElement = document.getElementById('comparison-status');
        statusElement.innerHTML = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">Error</span>';
        statusElement.classList.remove('hidden');
    } finally {
        // Hide loading state
        utils.hideLoading(compareBtn, originalText);
        
        // Hide progress section after a delay
        setTimeout(() => {
            document.getElementById('progress-section').classList.add('hidden');
        }, 2000);
    }
});

function updateProgress(percentage) {
    document.getElementById('progress-bar').style.width = percentage + '%';
    document.getElementById('progress-text').textContent = percentage + '%';
}

function displayComparisonResults(result) {
    const resultsContainer = document.getElementById('results-container');
    
    if (result.success && result.output) {
        // Parse the output to extract key information
        const output = result.output;
        
        // Extract summary information
        const structureMatch = output.match(/Common tags: (\d+)/);
        const contentDiffs = output.match(/Content differences: (\d+)/);
        const attrDiffs = output.match(/Attribute differences: (\d+)/);
        const reqs1 = output.match(/Requirements in File 1: (\d+)/);
        const reqs2 = output.match(/Requirements in File 2: (\d+)/);
        const commonReqs = output.match(/Common requirements: (\d+)/);
        
        // Create a formatted results display
        let resultsHTML = `
            <div class="space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-2xl font-bold text-gray-900">${structureMatch ? structureMatch[1] : 'N/A'}</p>
                        <p class="text-sm text-gray-600">Common Tags</p>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <p class="text-2xl font-bold text-red-600">${contentDiffs ? contentDiffs[1] : '0'}</p>
                        <p class="text-sm text-gray-600">Content Differences</p>
                    </div>
                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                        <p class="text-2xl font-bold text-yellow-600">${attrDiffs ? attrDiffs[1] : '0'}</p>
                        <p class="text-sm text-gray-600">Attribute Differences</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <p class="text-2xl font-bold text-green-600">${commonReqs ? commonReqs[1] : '0'}</p>
                        <p class="text-sm text-gray-600">Common Requirements</p>
                    </div>
                </div>
                
                <!-- Requirements Summary -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-900 mb-2">Requirements Summary</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium">File 1:</span> ${reqs1 ? reqs1[1] : '0'} requirements
                        </div>
                        <div>
                            <span class="font-medium">File 2:</span> ${reqs2 ? reqs2[1] : '0'} requirements
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Output -->
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">Detailed Analysis</h4>
                    <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-auto max-h-96">
                        <pre class="whitespace-pre-wrap">${result.output}</pre>
                    </div>
                </div>
                
                <!-- Export Button -->
                <div class="flex justify-end">
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-download mr-2"></i>
                        Export Report
                    </button>
                </div>
            </div>
        `;
        
        resultsContainer.innerHTML = resultsHTML;
    } else if (result.error) {
        resultsContainer.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-exclamation-triangle text-red-500"></i>
                    <span class="font-semibold text-red-800">Error</span>
                </div>
                <pre class="text-red-700 text-sm whitespace-pre-wrap">${result.error}</pre>
            </div>
        `;
    } else {
        resultsContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                <p>No results available</p>
            </div>
        `;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateCompareButton();
});
</script>
{% endblock %} 